import React, {createContext, useCallback, useContext, useEffect, useMemo, useState} from "react";
import AsyncStorage from "@react-native-async-storage/async-storage";

type Locale = "en" | "ko" | "ja" | "zh";

const STORAGE_KEY = "lovelybridge.locale";

const translations = {
    en: {
        appName: "LovelyBridge",
        tapTitle: "Tap the title to begin.",
        homeSubtitle: "Meet today's match.",
        login: "Login",
        signup: "Sign Up",
        exit: "Exit",
        settings: "Settings",
        quickLogin: "Quick Login",
        continueApple: "Continue with Apple",
        continueGoogle: "Continue with Google",
        continueKakao: "Continue with Kakao",
        loginWithEmail: "Login with email",
        email: "Email",
        password: "Password",
        passwordPlaceholder: "Enter password",
        loginAction: "Log in",
        termsNotice: "By logging in, you agree to the Terms and Privacy Policy.",
        firstTime: "New here? Sign Up",
        close: "Close",
        exitConfirm: "Are you sure you want to exit?",
        exitAction: "Exit",
        backToLogin: "Back to Login",
        language: "Language",
        languageHelp: "Choose the app language. It will be saved on this device.",
        languageSaved: "Language saved.",
        welcomeTitle: "Welcome",
        welcomeSubtitle: "A story that continues on LovelyBridge.",
        forgotPassword: "Forgot your password?",
        noAccount: "No account yet?",
        signupAction: "Sign Up",
        signupTitle: "Sign Up",
        signupSubtitle: "Start your story",
        signupBadge: "Meet someone new",
        nickname: "Nickname",
        passwordHint: "Use letters + numbers, 6+ characters.",
        passwordConfirm: "Confirm password",
        passwordConfirmPlaceholder: "Re-enter password",
        back: "Back",
        seeYouSoon: "See you soon",
        heartWelcome: "Your heart is always welcome back.",
        errorEmail: "Please enter a valid email.",
        errorPassword: "Please enter a password.",
        errorNickname: "Please enter a nickname.",
        errorPasswordSentence: "Please include an English sentence in the password.",
        errorPasswordConfirm: "Passwords do not match.",
        errorLoginFailed: "Login failed. Please check your credentials.",
        errorSignupFailed: "Sign up failed. Please try again.",
        loginSuccessTitle: "Login successful",
        loginSuccessBody: "Welcome back. Your journey continues here.",
        signupSuccessTitle: "Sign up complete",
        signupSuccessBody: "Your story starts now. Welcome aboard!",
        confirm: "Confirm",
        logout: "Log out",
        sessionExpired: "Session expired. Please log in again.",
        sessionTimeout: "Auto log out",
        sessionTimeoutHelp: "Log out if inactive for a while.",
        minutes: " min",
        customMinutes: "Custom minutes (1-240)",
        refreshFailedTitle: "Session expired",
        refreshFailedBody: "We couldn't refresh your login. Please log in again.",
        devNoticeTitle: "In development",
        devNoticeBody: "This feature is coming soon.",
        selectGender: "Select your gender",
        genderHelp: "Choose the avatar that feels right.",
        female: "Female",
        male: "Male",
        saveProfile: "Save profile",
        nicknamePlaceholder: "Enter your nickname",
        errorGender: "Please select a gender.",
        errorProfileSaveFailed: "Failed to save profile. Please try again.",
        profileSaved: "Profile saved successfully.",
        genderFemale: "Female",
        genderMale: "Male",
        genderOther: "Other",
        genderUnknown: "Unknown",
        welcomeUser: "Welcome, {nickname}",
        welcomeUserNoNickname: "Welcome",
        profileGenderLabel: "Gender",
        coupleStatusTitle: "Couple status",
        coupleConnectedWith: "Connected with",
        coupleNotConnected: "Not connected yet.",
        partnerUsernamePlaceholder: "Partner username",
        sendCoupleRequest: "Send couple request",
        refreshAction: "Refresh",
        incomingRequestsTitle: "Incoming requests",
        noIncomingRequests: "No incoming requests.",
        incomingRequestFrom: "Request from {username}",
        requestIdLabel: "Request ID: {id}",
        acceptAction: "Accept",
        rejectAction: "Reject",
        sentRequestsTitle: "Sent requests",
        noSentRequests: "No sent requests.",
        sentRequestTo: "Request sent to {username}",
        cancelAction: "Cancel",
        coupleErrorLoad: "Failed to load couple data.",
        coupleErrorNeedPartner: "Please enter a partner username.",
        coupleRequestSent: "Request sent.",
        coupleErrorRequestFailed: "Failed to send request.",
        coupleErrorAmbiguous: "Multiple users matched. Please use username or email.",
        coupleRequestAccepted: "Request accepted.",
        coupleErrorAcceptFailed: "Failed to accept request.",
        coupleRequestRejected: "Request rejected.",
        coupleErrorRejectFailed: "Failed to reject request.",
        coupleRequestCanceled: "Request canceled.",
        coupleErrorCancelFailed: "Failed to cancel request.",
        memoryCreateTitle: "Create Memory",
        memoryCreateSubtitle: "Record your precious moment.",
        memoryTitlePlaceholder: "Title",
        memoryContentPlaceholder: "Content",
        memoryDatePlaceholder: "Date / time (auto)",
        memorySaveAction: "Save memory",
        memorySaveAlertTitle: "Memory saved",
        memorySaveAlertBody: "Your memory has been saved.",
        memoryValidationRequired: "Please enter both title and content.",
        memorySaveErrorBody: "Failed to save memory. Please try again.",
        memoryListTitle: "Memory List",
        memoryListEmpty: "No memories yet.",
        memoryListLoadError: "Failed to load memories.",
        memoryDetailTitle: "Memory Detail",
        memoryDetailLoadError: "Failed to load memory.",
        memoryEditAction: "Edit memory",
        memoryDeleteAction: "Delete memory",
        memoryDeleteConfirm: "Are you sure you want to delete this memory?",
        memoryDeleteSuccess: "Memory deleted.",
        memoryDeleteError: "Failed to delete memory.",
        memoryUpdateSuccess: "Memory updated.",
        memoryUpdateError: "Failed to update memory.",
        memorySearchPlaceholder: "Search by title or content",
        memorySearchAction: "Search",
        memorySortLabel: "Sort",
        memorySortLatest: "Latest",
        memorySortOldest: "Oldest",
        memorySortTitleAsc: "Title A-Z",
        memorySortTitleDesc: "Title Z-A",
        profileEditTitle: "Edit Profile",
        profileEditSubtitle: "Keep your info up to date.",
        profileEditNicknamePlaceholder: "Nickname",
        profileEditFemale: "Female",
        profileEditMale: "Male",
        profileEditEmailPlaceholder: "Email",
        profileEditPasswordPlaceholder: "Password",
        profileEditSaveAction: "Save changes",
        profileEditAlertTitle: "Profile edit",
        profileEditAlertBody: "Failed to update profile. Please try again.",
        profileEditSaved: "Profile updated.",
        profileEditGenderHelp: "Gender can only be set once.",
        profileEditGenderLocked: "Gender is already set and cannot be changed.",
        passwordChangeTitle: "Change Password",
        passwordChangeSubtitle: "Verify your current password first.",
        passwordChangeCurrentPlaceholder: "Current password",
        passwordChangeVerifyAction: "Verify",
        passwordChangeCurrentRequired: "Please enter your current password.",
        passwordChangeVerified: "Verification complete. Enter a new password.",
        passwordChangeVerifyFailed: "Current password does not match.",
        passwordChangeNewPlaceholder: "New password",
        passwordChangeConfirmPlaceholder: "Confirm new password",
        passwordChangeNewRequired: "Please enter a new password.",
        passwordChangeConfirmMismatch: "New passwords do not match.",
        passwordChangeSubmitAction: "Change password",
        passwordChangeSuccess: "Password changed successfully.",
        passwordChangeFailed: "Failed to change password.",
        attendanceTitle: "Attendance",
        attendanceSubtitle: "Glad to have you today.",
        attendanceTodayDate: "Today",
        attendanceStreakCount: "Streak: {count}",
        attendanceStatusLabel: "Today's status",
        attendanceStatusDone: "Checked in",
        attendanceStatusPending: "Not checked in",
        attendanceCheckInAction: "Check in today",
        attendanceErrorLoad: "Failed to load attendance data.",
        attendanceErrorCheckIn: "Failed to check in.",
        attendanceAlreadyCheckedIn: "Already checked in today.",
        attendanceCheckedInSuccess: "Check-in complete!",
    },
    ko: {
        appName: "LovelyBridge",
        tapTitle: "타이틀을 눌러 시작하세요.",
        homeSubtitle: "오늘의 인연을 만나보세요",
        login: "로그인",
        signup: "회원가입",
        exit: "나가기",
        settings: "설정",
        quickLogin: "빠른 로그인",
        continueApple: "Apple로 계속하기",
        continueGoogle: "Google로 계속하기",
        continueKakao: "Kakao로 계속하기",
        loginWithEmail: "이메일로 로그인",
        email: "이메일",
        password: "비밀번호",
        passwordPlaceholder: "비밀번호 입력",
        loginAction: "로그인하기",
        termsNotice: "로그인하면 이용약관 및 개인정보 처리방침에 동의한 것으로 간주됩니다.",
        firstTime: "처음이신가요? 회원가입",
        close: "닫기",
        exitConfirm: "정말 종료하시겠어요?",
        exitAction: "종료",
        backToLogin: "로그인으로 돌아가기",
        language: "언어",
        languageHelp: "앱 언어를 선택해 주세요. 이 기기에 저장됩니다.",
        languageSaved: "언어가 저장되었습니다.",
        welcomeTitle: "환영해요",
        welcomeSubtitle: "LovelyBridge에서 이어지는 이야기.",
        forgotPassword: "비밀번호를 잊으셨나요?",
        noAccount: "아직 계정이 없나요?",
        signupAction: "회원가입",
        signupTitle: "Sign Up",
        signupSubtitle: "당신의 이야기를 시작해요",
        signupBadge: "새로운 인연 만들기",
        nickname: "닉네임",
        passwordHint: "영문 + 숫자 조합, 6자 이상",
        passwordConfirm: "비밀번호 확인",
        passwordConfirmPlaceholder: "비밀번호 재입력",
        back: "뒤로",
        seeYouSoon: "곧 다시 만나요",
        heartWelcome: "마음은 언제든 돌아올 수 있어요.",
        errorEmail: "이메일 형식의 아이디를 입력해 주세요.",
        errorPassword: "비밀번호를 입력해 주세요.",
        errorNickname: "닉네임을 입력해 주세요.",
        errorPasswordSentence: "비밀번호에 영어 문장을 포함해 주세요.",
        errorPasswordConfirm: "비밀번호가 일치하지 않아요.",
        errorLoginFailed: "로그인에 실패했어요. 아이디와 비밀번호를 확인해 주세요.",
        errorSignupFailed: "회원가입에 실패했어요. 잠시 후 다시 시도해 주세요.",
        loginSuccessTitle: "로그인 성공",
        loginSuccessBody: "다시 만나 반가워요. 이어지는 이야기를 시작해요.",
        signupSuccessTitle: "회원가입 완료",
        signupSuccessBody: "당신의 이야기가 지금부터 시작돼요.",
        confirm: "확인",
        logout: "로그아웃",
        sessionExpired: "세션이 만료되었어요. 다시 로그인해 주세요.",
        sessionTimeout: "자동 로그아웃",
        sessionTimeoutHelp: "오랫동안 활동이 없으면 로그아웃됩니다.",
        minutes: "분",
        customMinutes: "직접 설정 (1-240)",
        refreshFailedTitle: "세션이 만료되었어요",
        refreshFailedBody: "로그인을 갱신할 수 없어요. 다시 로그인해 주세요.",
        devNoticeTitle: "개발중",
        devNoticeBody: "곧 제공될 예정이에요.",
        selectGender: "성별 선택",
        genderHelp: "마음에 드는 아바타를 골라주세요.",
        female: "여성",
        male: "남성",
        saveProfile: "프로필 저장",
        nicknamePlaceholder: "닉네임을 입력해 주세요",
        errorGender: "성별을 선택해 주세요.",
        errorProfileSaveFailed: "프로필 저장에 실패했어요. 다시 시도해 주세요.",
        profileSaved: "프로필이 저장되었어요.",
        genderFemale: "여성",
        genderMale: "남성",
        genderOther: "기타",
        genderUnknown: "알 수 없음",
        welcomeUser: "어서오세요 {nickname}님",
        welcomeUserNoNickname: "어서오세요",
        profileGenderLabel: "성별",
        coupleStatusTitle: "커플 상태",
        coupleConnectedWith: "연결됨",
        coupleNotConnected: "아직 커플이 연결되지 않았습니다.",
        partnerUsernamePlaceholder: "상대 아이디(username)",
        sendCoupleRequest: "커플 신청 보내기",
        refreshAction: "새로고침",
        incomingRequestsTitle: "받은 커플 신청",
        noIncomingRequests: "받은 신청이 없습니다.",
        incomingRequestFrom: "{username} 님의 신청",
        requestIdLabel: "요청 ID: {id}",
        acceptAction: "수락하기",
        rejectAction: "거절하기",
        sentRequestsTitle: "보낸 커플 신청",
        noSentRequests: "보낸 신청이 없습니다.",
        sentRequestTo: "{username} 님에게 보낸 신청",
        cancelAction: "취소하기",
        coupleErrorLoad: "커플 정보를 불러오지 못했습니다.",
        coupleErrorNeedPartner: "상대 아이디를 입력해 주세요.",
        coupleRequestSent: "커플 신청을 보냈습니다.",
        coupleErrorRequestFailed: "커플 신청에 실패했습니다.",
        coupleErrorAmbiguous: "일치하는 사용자가 여러 명입니다. 아이디 또는 이메일을 입력해 주세요.",
        coupleRequestAccepted: "커플 신청을 수락했습니다.",
        coupleErrorAcceptFailed: "수락에 실패했습니다.",
        coupleRequestRejected: "커플 신청을 거절했습니다.",
        coupleErrorRejectFailed: "거절에 실패했습니다.",
        coupleRequestCanceled: "보낸 커플 신청을 취소했습니다.",
        coupleErrorCancelFailed: "신청 취소에 실패했습니다.",
        memoryCreateTitle: "추억만들기",
        memoryCreateSubtitle: "소중한 순간을 기록해 주세요.",
        memoryTitlePlaceholder: "제목",
        memoryContentPlaceholder: "내용",
        memoryDatePlaceholder: "날짜/시간 (자동)",
        memorySaveAction: "추억 저장하기",
        memorySaveAlertTitle: "추억 저장",
        memorySaveAlertBody: "추억이 저장되었습니다.",
        memoryValidationRequired: "제목과 내용을 모두 입력해 주세요.",
        memorySaveErrorBody: "추억 저장에 실패했습니다. 다시 시도해 주세요.",
        memoryListTitle: "추억 리스트",
        memoryListEmpty: "아직 추억이 없습니다.",
        memoryListLoadError: "추억 목록을 불러오지 못했습니다.",
        memoryDetailTitle: "추억 상세",
        memoryDetailLoadError: "추억을 불러오지 못했습니다.",
        memoryEditAction: "추억 수정",
        memoryDeleteAction: "추억 삭제",
        memoryDeleteConfirm: "이 추억을 삭제하시겠어요?",
        memoryDeleteSuccess: "추억이 삭제되었습니다.",
        memoryDeleteError: "추억 삭제에 실패했습니다.",
        memoryUpdateSuccess: "추억이 수정되었습니다.",
        memoryUpdateError: "추억 수정에 실패했습니다.",
        memorySearchPlaceholder: "제목 또는 내용 검색",
        memorySearchAction: "검색",
        memorySortLabel: "정렬",
        memorySortLatest: "최신순",
        memorySortOldest: "오래된순",
        memorySortTitleAsc: "제목 오름차순",
        memorySortTitleDesc: "제목 내림차순",
        profileEditTitle: "개인정보 변경",
        profileEditSubtitle: "최신 정보로 업데이트해 주세요.",
        profileEditNicknamePlaceholder: "닉네임",
        profileEditFemale: "여성",
        profileEditMale: "남성",
        profileEditEmailPlaceholder: "이메일",
        profileEditPasswordPlaceholder: "비밀번호",
        profileEditSaveAction: "변경 사항 저장",
        profileEditAlertTitle: "개인정보 변경",
        profileEditAlertBody: "프로필 변경에 실패했습니다. 다시 시도해 주세요.",
        profileEditSaved: "프로필이 변경되었습니다.",
        profileEditGenderHelp: "성별은 한 번 설정하면 변경할 수 없습니다.",
        profileEditGenderLocked: "성별이 이미 설정되어 변경할 수 없습니다.",
        passwordChangeTitle: "비밀번호 변경",
        passwordChangeSubtitle: "먼저 현재 비밀번호를 확인해 주세요.",
        passwordChangeCurrentPlaceholder: "현재 비밀번호",
        passwordChangeVerifyAction: "현재 비밀번호 확인",
        passwordChangeCurrentRequired: "현재 비밀번호를 입력해 주세요.",
        passwordChangeVerified: "확인되었습니다. 새 비밀번호를 입력해 주세요.",
        passwordChangeVerifyFailed: "현재 비밀번호가 일치하지 않습니다.",
        passwordChangeNewPlaceholder: "새 비밀번호",
        passwordChangeConfirmPlaceholder: "새 비밀번호 확인",
        passwordChangeNewRequired: "새 비밀번호를 입력해 주세요.",
        passwordChangeConfirmMismatch: "새 비밀번호가 일치하지 않습니다.",
        passwordChangeSubmitAction: "비밀번호 변경",
        passwordChangeSuccess: "비밀번호가 변경되었습니다.",
        passwordChangeFailed: "비밀번호 변경에 실패했습니다.",
        attendanceTitle: "출석하기",
        attendanceSubtitle: "오늘도 함께해요.",
        attendanceTodayDate: "오늘 날짜",
        attendanceStreakCount: "연속 출석 횟수: {count}",
        attendanceStatusLabel: "오늘 출석 상태",
        attendanceStatusDone: "완료",
        attendanceStatusPending: "미출석",
        attendanceCheckInAction: "오늘 출석하기",
        attendanceErrorLoad: "출석 정보를 불러오지 못했습니다.",
        attendanceErrorCheckIn: "출석 처리에 실패했습니다.",
        attendanceAlreadyCheckedIn: "오늘은 이미 출석했어요.",
        attendanceCheckedInSuccess: "출석 완료!",
    },
    ja: {
        appName: "LovelyBridge",
        tapTitle: "タイトルをタップして始めましょう。",
        homeSubtitle: "今日の出会いを見つけましょう。",
        login: "ログイン",
        signup: "新規登録",
        exit: "終了",
        settings: "設定",
        quickLogin: "クイックログイン",
        continueApple: "Appleで続ける",
        continueGoogle: "Googleで続ける",
        continueKakao: "Kakaoで続ける",
        loginWithEmail: "メールでログイン",
        email: "メール",
        password: "パスワード",
        passwordPlaceholder: "パスワードを入力",
        loginAction: "ログイン",
        termsNotice: "ログインすると利用規約とプライバシーに同意したものとします。",
        firstTime: "初めてですか？新規登録",
        close: "閉じる",
        exitConfirm: "終了してもよろしいですか？",
        exitAction: "終了",
        backToLogin: "ログインに戻る",
        language: "言語",
        languageHelp: "アプリの言語を選択してください。この端末に保存されます。",
        languageSaved: "言語を保存しました。",
        welcomeTitle: "ようこそ",
        welcomeSubtitle: "LovelyBridgeで続く物語。",
        forgotPassword: "パスワードを忘れましたか？",
        noAccount: "アカウントがありませんか？",
        signupAction: "新規登録",
        signupTitle: "Sign Up",
        signupSubtitle: "あなたの物語を始めよう",
        signupBadge: "新しい出会い",
        nickname: "ニックネーム",
        passwordHint: "英字＋数字、6文字以上",
        passwordConfirm: "パスワード確認",
        passwordConfirmPlaceholder: "パスワードを再入力",
        back: "戻る",
        seeYouSoon: "また会いましょう",
        heartWelcome: "いつでもお帰りください。",
        errorEmail: "有効なメールアドレスを入力してください。",
        errorPassword: "パスワードを入力してください。",
        errorNickname: "ニックネームを入力してください。",
        errorPasswordSentence: "パスワードに英語の文を含めてください。",
        errorPasswordConfirm: "パスワードが一致しません。",
        errorLoginFailed: "ログインに失敗しました。認証情報を確認してください。",
        errorSignupFailed: "登録に失敗しました。もう一度お試しください。",
        loginSuccessTitle: "ログイン成功",
        loginSuccessBody: "おかえりなさい。物語を続けましょう。",
        signupSuccessTitle: "登録完了",
        signupSuccessBody: "あなたの物語が今始まります。",
        confirm: "確認",
        logout: "ログアウト",
        sessionExpired: "セッションの有効期限が切れました。再度ログインしてください。",
        sessionTimeout: "自動ログアウト",
        sessionTimeoutHelp: "一定時間操作がないとログアウトします。",
        minutes: "分",
        customMinutes: "カスタム (1-240)",
        refreshFailedTitle: "セッションが切れました",
        refreshFailedBody: "再ログインが必要です。もう一度ログインしてください。",
        devNoticeTitle: "開発中",
        devNoticeBody: "近日公開予定です。",
        selectGender: "性別を選択",
        genderHelp: "ぴったりのアバターを選んでください。",
        female: "女性",
        male: "男性",
        saveProfile: "プロフィールを保存",
        nicknamePlaceholder: "ニックネームを入力してください",
        errorGender: "性別を選択してください。",
        errorProfileSaveFailed: "プロフィールの保存に失敗しました。もう一度お試しください。",
        profileSaved: "プロフィールを保存しました。",
        genderFemale: "女性",
        genderMale: "男性",
        genderOther: "その他",
        genderUnknown: "不明",
        welcomeUser: "ようこそ {nickname}さん",
        welcomeUserNoNickname: "ようこそ",
        profileGenderLabel: "性別",
        coupleStatusTitle: "カップル状態",
        coupleConnectedWith: "接続中",
        coupleNotConnected: "まだ接続されていません。",
        partnerUsernamePlaceholder: "相手のユーザー名",
        sendCoupleRequest: "カップル申請を送る",
        refreshAction: "更新",
        incomingRequestsTitle: "受信申請",
        noIncomingRequests: "受信申請はありません。",
        incomingRequestFrom: "{username}さんからの申請",
        requestIdLabel: "申請ID: {id}",
        acceptAction: "承認",
        rejectAction: "拒否",
        sentRequestsTitle: "送信申請",
        noSentRequests: "送信申請はありません。",
        sentRequestTo: "{username}さんへの申請",
        cancelAction: "取り消し",
        coupleErrorLoad: "カップル情報を読み込めませんでした。",
        coupleErrorNeedPartner: "相手のユーザー名を入力してください。",
        coupleRequestSent: "申請を送信しました。",
        coupleErrorRequestFailed: "申請送信に失敗しました。",
        coupleErrorAmbiguous: "一致するユーザーが複数います。ユーザー名またはメールを入力してください。",
        coupleRequestAccepted: "申請を承認しました。",
        coupleErrorAcceptFailed: "承認に失敗しました。",
        coupleRequestRejected: "申請を拒否しました。",
        coupleErrorRejectFailed: "拒否に失敗しました。",
        coupleRequestCanceled: "送信した申請を取り消しました。",
        coupleErrorCancelFailed: "申請取り消しに失敗しました。",
        memoryCreateTitle: "思い出作成",
        memoryCreateSubtitle: "大切な瞬間を記録しましょう。",
        memoryTitlePlaceholder: "タイトル",
        memoryContentPlaceholder: "内容",
        memoryDatePlaceholder: "日時（自動）",
        memorySaveAction: "思い出を保存",
        memorySaveAlertTitle: "思い出保存",
        memorySaveAlertBody: "思い出を保存しました。",
        memoryValidationRequired: "タイトルと内容を入力してください。",
        memorySaveErrorBody: "思い出の保存に失敗しました。再試行してください。",
        memoryListTitle: "思い出リスト",
        memoryListEmpty: "まだ思い出がありません。",
        memoryListLoadError: "思い出一覧の読み込みに失敗しました。",
        memoryDetailTitle: "思い出詳細",
        memoryDetailLoadError: "思い出の読み込みに失敗しました。",
        memoryEditAction: "思い出を編集",
        memoryDeleteAction: "思い出を削除",
        memoryDeleteConfirm: "この思い出を削除しますか？",
        memoryDeleteSuccess: "思い出を削除しました。",
        memoryDeleteError: "思い出の削除に失敗しました。",
        memoryUpdateSuccess: "思い出を更新しました。",
        memoryUpdateError: "思い出の更新に失敗しました。",
        memorySearchPlaceholder: "タイトル・内容で検索",
        memorySearchAction: "検索",
        memorySortLabel: "並び替え",
        memorySortLatest: "新しい順",
        memorySortOldest: "古い順",
        memorySortTitleAsc: "タイトル昇順",
        memorySortTitleDesc: "タイトル降順",
        profileEditTitle: "プロフィール編集",
        profileEditSubtitle: "最新の情報に更新してください。",
        profileEditNicknamePlaceholder: "ニックネーム",
        profileEditFemale: "女性",
        profileEditMale: "男性",
        profileEditEmailPlaceholder: "メール",
        profileEditPasswordPlaceholder: "パスワード",
        profileEditSaveAction: "変更を保存",
        profileEditAlertTitle: "プロフィール編集",
        profileEditAlertBody: "プロフィールの更新に失敗しました。再試行してください。",
        profileEditSaved: "プロフィールを更新しました。",
        profileEditGenderHelp: "性別は一度設定すると変更できません。",
        profileEditGenderLocked: "性別はすでに設定されており変更できません。",
        passwordChangeTitle: "パスワード変更",
        passwordChangeSubtitle: "先に現在のパスワードを確認してください。",
        passwordChangeCurrentPlaceholder: "現在のパスワード",
        passwordChangeVerifyAction: "現在パスワード確認",
        passwordChangeCurrentRequired: "現在のパスワードを入力してください。",
        passwordChangeVerified: "確認できました。新しいパスワードを入力してください。",
        passwordChangeVerifyFailed: "現在のパスワードが一致しません。",
        passwordChangeNewPlaceholder: "新しいパスワード",
        passwordChangeConfirmPlaceholder: "新しいパスワード確認",
        passwordChangeNewRequired: "新しいパスワードを入力してください。",
        passwordChangeConfirmMismatch: "新しいパスワードが一致しません。",
        passwordChangeSubmitAction: "パスワード変更",
        passwordChangeSuccess: "パスワードを変更しました。",
        passwordChangeFailed: "パスワード変更に失敗しました。",
        attendanceTitle: "出席",
        attendanceSubtitle: "今日も一緒にいきましょう。",
        attendanceTodayDate: "今日の日付",
        attendanceStreakCount: "連続出席: {count}",
        attendanceStatusLabel: "本日の状態",
        attendanceStatusDone: "完了",
        attendanceStatusPending: "未出席",
        attendanceCheckInAction: "今日出席する",
        attendanceErrorLoad: "出席情報を読み込めませんでした。",
        attendanceErrorCheckIn: "出席処理に失敗しました。",
        attendanceAlreadyCheckedIn: "今日はすでに出席済みです。",
        attendanceCheckedInSuccess: "出席完了！",
    },
    zh: {
        appName: "LovelyBridge",
        tapTitle: "点击标题开始。",
        homeSubtitle: "遇见今天的缘分。",
        login: "登录",
        signup: "注册",
        exit: "退出",
        settings: "设置",
        quickLogin: "快速登录",
        continueApple: "使用 Apple 继续",
        continueGoogle: "使用 Google 继续",
        continueKakao: "使用 Kakao 继续",
        loginWithEmail: "使用邮箱登录",
        email: "邮箱",
        password: "密码",
        passwordPlaceholder: "请输入密码",
        loginAction: "登录",
        termsNotice: "登录即表示你同意条款与隐私政策。",
        firstTime: "新用户？注册",
        close: "关闭",
        exitConfirm: "确定要退出吗？",
        exitAction: "退出",
        backToLogin: "返回登录",
        language: "语言",
        languageHelp: "请选择应用语言。将保存在此设备上。",
        languageSaved: "语言已保存。",
        welcomeTitle: "欢迎",
        welcomeSubtitle: "在 LovelyBridge 继续你的故事。",
        forgotPassword: "忘记密码？",
        noAccount: "还没有账号？",
        signupAction: "注册",
        signupTitle: "Sign Up",
        signupSubtitle: "开启你的故事",
        signupBadge: "遇见新缘分",
        nickname: "昵称",
        passwordHint: "字母 + 数字，至少 6 位",
        passwordConfirm: "确认密码",
        passwordConfirmPlaceholder: "再次输入密码",
        back: "返回",
        seeYouSoon: "很快再见",
        heartWelcome: "你的心永远欢迎回来。",
        errorEmail: "请输入有效的邮箱地址。",
        errorPassword: "请输入密码。",
        errorNickname: "请输入昵称。",
        errorPasswordSentence: "密码中请包含英文句子。",
        errorPasswordConfirm: "两次密码不一致。",
        errorLoginFailed: "登录失败，请检查账号密码。",
        errorSignupFailed: "注册失败，请稍后重试。",
        loginSuccessTitle: "登录成功",
        loginSuccessBody: "欢迎回来，故事继续。",
        signupSuccessTitle: "注册完成",
        signupSuccessBody: "你的故事现在开始。",
        confirm: "确定",
        logout: "退出登录",
        sessionExpired: "会话已过期，请重新登录。",
        sessionTimeout: "自动退出",
        sessionTimeoutHelp: "长时间未操作将自动退出。",
        minutes: " 分",
        customMinutes: "自定义 (1-240)",
        refreshFailedTitle: "会话已过期",
        refreshFailedBody: "无法刷新登录，请重新登录。",
        devNoticeTitle: "开发中",
        devNoticeBody: "即将提供。",
        selectGender: "选择性别",
        genderHelp: "请选择合适的头像。",
        female: "女性",
        male: "男性",
        saveProfile: "保存资料",
        nicknamePlaceholder: "请输入昵称",
        errorGender: "请选择性别。",
        errorProfileSaveFailed: "保存资料失败，请重试。",
        profileSaved: "资料已保存。",
        genderFemale: "女性",
        genderMale: "男性",
        genderOther: "其他",
        genderUnknown: "未知",
        welcomeUser: "欢迎你，{nickname}",
        welcomeUserNoNickname: "欢迎",
        profileGenderLabel: "性别",
        coupleStatusTitle: "情侣状态",
        coupleConnectedWith: "已连接",
        coupleNotConnected: "尚未建立情侣关系。",
        partnerUsernamePlaceholder: "对方用户名",
        sendCoupleRequest: "发送情侣申请",
        refreshAction: "刷新",
        incomingRequestsTitle: "收到的申请",
        noIncomingRequests: "暂无收到的申请。",
        incomingRequestFrom: "来自 {username} 的申请",
        requestIdLabel: "申请ID: {id}",
        acceptAction: "接受",
        rejectAction: "拒绝",
        sentRequestsTitle: "已发送申请",
        noSentRequests: "暂无已发送申请。",
        sentRequestTo: "发送给 {username} 的申请",
        cancelAction: "取消",
        coupleErrorLoad: "加载情侣信息失败。",
        coupleErrorNeedPartner: "请输入对方用户名。",
        coupleRequestSent: "已发送情侣申请。",
        coupleErrorRequestFailed: "发送申请失败。",
        coupleErrorAmbiguous: "匹配到多个用户，请输入用户名或邮箱。",
        coupleRequestAccepted: "已接受情侣申请。",
        coupleErrorAcceptFailed: "接受失败。",
        coupleRequestRejected: "已拒绝情侣申请。",
        coupleErrorRejectFailed: "拒绝失败。",
        coupleRequestCanceled: "已取消已发送申请。",
        coupleErrorCancelFailed: "取消申请失败。",
        memoryCreateTitle: "创建回忆",
        memoryCreateSubtitle: "记录你的珍贵瞬间。",
        memoryTitlePlaceholder: "标题",
        memoryContentPlaceholder: "内容",
        memoryDatePlaceholder: "日期/时间（自动）",
        memorySaveAction: "保存回忆",
        memorySaveAlertTitle: "回忆已保存",
        memorySaveAlertBody: "回忆已保存。",
        memoryValidationRequired: "请输入标题和内容。",
        memorySaveErrorBody: "保存回忆失败，请重试。",
        memoryListTitle: "回忆列表",
        memoryListEmpty: "还没有回忆。",
        memoryListLoadError: "加载回忆列表失败。",
        memoryDetailTitle: "回忆详情",
        memoryDetailLoadError: "加载回忆失败。",
        memoryEditAction: "编辑回忆",
        memoryDeleteAction: "删除回忆",
        memoryDeleteConfirm: "确定要删除这条回忆吗？",
        memoryDeleteSuccess: "回忆已删除。",
        memoryDeleteError: "删除回忆失败。",
        memoryUpdateSuccess: "回忆已更新。",
        memoryUpdateError: "更新回忆失败。",
        memorySearchPlaceholder: "按标题或内容搜索",
        memorySearchAction: "搜索",
        memorySortLabel: "排序",
        memorySortLatest: "最新",
        memorySortOldest: "最早",
        memorySortTitleAsc: "标题升序",
        memorySortTitleDesc: "标题降序",
        profileEditTitle: "修改个人信息",
        profileEditSubtitle: "请更新为最新信息。",
        profileEditNicknamePlaceholder: "昵称",
        profileEditFemale: "女性",
        profileEditMale: "男性",
        profileEditEmailPlaceholder: "邮箱",
        profileEditPasswordPlaceholder: "密码",
        profileEditSaveAction: "保存修改",
        profileEditAlertTitle: "个人信息修改",
        profileEditAlertBody: "修改资料失败，请重试。",
        profileEditSaved: "资料已更新。",
        profileEditGenderHelp: "性别设置后不可更改。",
        profileEditGenderLocked: "性别已设置，无法更改。",
        passwordChangeTitle: "修改密码",
        passwordChangeSubtitle: "请先验证当前密码。",
        passwordChangeCurrentPlaceholder: "当前密码",
        passwordChangeVerifyAction: "验证当前密码",
        passwordChangeCurrentRequired: "请输入当前密码。",
        passwordChangeVerified: "验证成功，请输入新密码。",
        passwordChangeVerifyFailed: "当前密码不正确。",
        passwordChangeNewPlaceholder: "新密码",
        passwordChangeConfirmPlaceholder: "确认新密码",
        passwordChangeNewRequired: "请输入新密码。",
        passwordChangeConfirmMismatch: "两次新密码不一致。",
        passwordChangeSubmitAction: "修改密码",
        passwordChangeSuccess: "密码修改成功。",
        passwordChangeFailed: "修改密码失败。",
        attendanceTitle: "签到",
        attendanceSubtitle: "今天也一起加油。",
        attendanceTodayDate: "今日日期",
        attendanceStreakCount: "连续签到: {count}",
        attendanceStatusLabel: "今日状态",
        attendanceStatusDone: "已签到",
        attendanceStatusPending: "未签到",
        attendanceCheckInAction: "今日签到",
        attendanceErrorLoad: "加载签到信息失败。",
        attendanceErrorCheckIn: "签到失败。",
        attendanceAlreadyCheckedIn: "今天已经签到过了。",
        attendanceCheckedInSuccess: "签到成功！",
    },
} as const;

type TranslationKey = keyof typeof translations.en;

const isLocale = (value: string): value is Locale =>
    value === "en" || value === "ko" || value === "ja" || value === "zh";

const normalizeLocale = (locale?: string): Locale => {
    const tag = (locale || "en").toLowerCase();
    if (tag.startsWith("ko")) return "ko";
    if (tag.startsWith("ja")) return "ja";
    if (tag.startsWith("zh")) return "zh";
    return "en";
};

const getDeviceLocale = (): Locale => {
    try {
        const locale = Intl.DateTimeFormat().resolvedOptions().locale;
        return normalizeLocale(locale);
    } catch {
        return "en";
    }
};

type I18nContextValue = {
    locale: Locale;
    setLocale: (locale: Locale) => void;
    t: (key: TranslationKey) => string;
};

const I18nContext = createContext<I18nContextValue>({
    locale: "en",
    setLocale: () => undefined,
    t: (key) => translations.en[key] ?? key,
});

export function I18nProvider({children}: {children: React.ReactNode}) {
    const [locale, setLocale] = useState<Locale>(getDeviceLocale());

    useEffect(() => {
        let active = true;
        (async () => {
            try {
                const saved = await AsyncStorage.getItem(STORAGE_KEY);
                if (saved && isLocale(saved) && active) {
                    setLocale(saved);
                }
            } catch {
                // Ignore persistence errors; fallback to device locale.
            }
        })();
        return () => {
            active = false;
        };
    }, []);

    const t = useCallback(
        (key: TranslationKey) => translations[locale]?.[key] ?? translations.en[key] ?? key,
        [locale],
    );

    const setLocalePersist = useCallback((next: Locale) => {
        setLocale(next);
        AsyncStorage.setItem(STORAGE_KEY, next).catch(() => undefined);
    }, []);

    const value = useMemo(
        () => ({
            locale,
            setLocale: setLocalePersist,
            t,
        }),
        [locale, setLocalePersist, t],
    );

    return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
}

export function useI18n() {
    return useContext(I18nContext);
}

export type {Locale, TranslationKey};
